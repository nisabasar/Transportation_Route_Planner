{% extends "base.html" %}
{% block title %}Rota SonuÃ§larÄ±{% endblock %}
{% block content %}
<div class="fade-in-up">
  <h1 class="mb-4">Rota SonuÃ§larÄ±</h1>
  <p>Hesaplanan alternatif rota seÃ§enekleri aÅŸaÄŸÄ±dadÄ±r.</p>

  {% set route_labels = {
    "rotaniz":"RotanÄ±z",
    "sadece_taksi":"ğŸš– Sadece Taksi",
    "sadece_otobus":"ğŸšŒ Sadece OtobÃ¼s",
    "sadece_tramvay":"ğŸš‹ Sadece Tramvay",
    "otobus_tramvay":"ğŸšŒ+ğŸš‹ OtobÃ¼s + Tramvay",
    "taksi_otobus_tramvay":"ğŸš–+ğŸšŒ/ğŸš‹"
  } %}

  <ul class="nav nav-tabs" id="routeTab" role="tablist">
    {% for rkey, route in routes.items() %}
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if loop.first %}active{% endif %}"
              id="{{ rkey }}-tab"
              data-bs-toggle="tab"
              data-bs-target="#{{ rkey }}"
              type="button"
              role="tab"
              aria-controls="{{ rkey }}"
              aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
        {{ route_labels.get(rkey, rkey) }}
      </button>
    </li>
    {% endfor %}
  </ul>

  <div class="tab-content mt-3" id="routeTabContent">
    {% for rkey, route in routes.items() %}
    <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
         id="{{ rkey }}"
         role="tabpanel"
         aria-labelledby="{{ rkey }}-tab">
      {% if route %}
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">{{ route_labels.get(rkey, rkey) }} Rota DetaylarÄ±</h5>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>AÅŸama</th>
                  <th>BaÅŸlangÄ±Ã§</th>
                  <th>VarÄ±ÅŸ</th>
                  <th>UlaÅŸÄ±m</th>
                  <th>SÃ¼re (dk)</th>
                  <th>Mesafe (km)</th>
                  <th>Base Ãœcret (TL)</th>
                  <th>Final Ãœcret (TL)</th>
                  <th>AÃ§Ä±klama</th>
                </tr>
              </thead>
              <tbody>
                {% for step in route.steps %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ step.from }}</td>
                  <td>{{ step.to }}</td>
                  <td>
                    {% if step.mode=='walk' %}ğŸš¶ YÃ¼rÃ¼me
                    {% elif step.mode=='taksi' %}ğŸš– Taksi
                    {% elif step.mode=='bus' %}ğŸšŒ OtobÃ¼s
                    {% elif step.mode=='tram' %}ğŸš‹ Tramvay
                    {% elif step.mode=='transfer' %}ğŸ”„ Transfer
                    {% else %}{{ step.mode }}{% endif %}
                  </td>
                  <td>{{ step.time }}</td>
                  <td>{{ step.distance }}</td>
                  <td>{{ step.base_cost }}</td>
                  <td>{{ step.final_cost }}</td>
                  <td>{{ step.discount_explanation }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <p><strong>Toplam SÃ¼re:</strong> {{ route.total_time }} dk</p>
          <p><strong>Toplam Mesafe:</strong> {{ route.total_distance }} km</p>
          <p><strong>Toplam Ãœcret:</strong> {{ route.total_cost }} TL</p>
          {% if route.arrival_time %}
            <p><strong>VarÄ±ÅŸ Saati:</strong> {{ route.arrival_time }}</p>
          {% endif %}
          {% if payment_results[rkey] %}
            <p><strong>Ã–deme Durumu:</strong> {{ payment_results[rkey].message }}</p>
          {% endif %}
          <div id="map_{{ rkey }}" style="height:300px;"></div>
        </div>
      </div>
      {% else %}
      <div class="alert alert-warning">Bu rota iÃ§in uygun baÄŸlantÄ± bulunamadÄ±.</div>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <div class="text-center">
    <a href="{{ url_for('route_page') }}" class="btn btn-success btn-lg">Yeni Rota Hesapla</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<!-- TÃ¼m duraklarÄ± JSON olarak aktarÄ±yoruz. 
     Sunucuda stops.json iÃ§indeki "duraklar" listesini 
     duraklar = stops_data["duraklar"] ÅŸeklinde alÄ±p 
     render_template(...) ile gÃ¶nderdiÄŸinizi varsayalÄ±m. -->
<script>
  const allStops = {{ duraklar|tojson }};
</script>

<!-- Rota Ã§izmeyi yapan JS dosyasÄ± -->
<script src="{{ url_for('static', filename='js/map_draw.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let routeMaps = {};

  {% for rkey, route in routes.items() %}
    {% if route and route.latlon_segments %}
      /*
        drawRouteOnMap(mapId, segments, forceCenter, stops)
        => stops parametresi olarak allStops gÃ¶nderiyoruz.
      */
      routeMaps["{{ rkey }}"] = drawRouteOnMap(
        "map_{{ rkey }}",
        {{ route.latlon_segments|tojson }},
        false,
        allStops
      );
    {% else %}
      routeMaps["{{ rkey }}"] = null;
    {% endif %}
  {% endfor %}

  // Tab deÄŸiÅŸtirince haritanÄ±n boyutunu gÃ¼ncelle
  const tabButtons = document.querySelectorAll('button[data-bs-toggle="tab"]');
  tabButtons.forEach((btn) => {
    btn.addEventListener("shown.bs.tab", (event) => {
      const targetId = event.target.getAttribute("data-bs-target").replace("#", "");
      const mapObj = routeMaps[targetId];
      if (mapObj) {
        setTimeout(() => {
          mapObj.invalidateSize();
        }, 50);
      }
    });
  });
});
</script>
{% endblock %}
